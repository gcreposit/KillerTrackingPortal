<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet">

    <title>User Location Tracking</title>
    <script async
            defer
            src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAkyZ_KEJyO9abb8-TW96HaE-Uu_3q4IQw&callback=initMap"></script>
    <script src="https://cdn.jsdelivr.net/gh/googlemaps/v3-utility-library/markerclusterer/src/markerclusterer.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <style>
        /* General styles */
        body {
            font-family: 'Arial', sans-serif;
            background-color: #fafafa;
            margin: 0;
            padding: 0;
        }

        /* Container for map and table */
        #map {
            height: 60vh;
            width: 100%;
        }

        /* Table styles */
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            background-color: #fff;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        table, th, td {
            border: 1px solid #ddd;
            text-align: left;
            padding: 12px 15px;
        }

        th {
            background-color: #f1f1f1;
            color: #333;
        }

        tr:nth-child(even) {
            background-color: #f9f9f9;
        }

        /* Buttons and Filters */
        #hourFilters {
            position: fixed;
            bottom: 20px;
            right: 20px;
            display: flex;
            gap: 10px; /* Space between buttons */
            flex-wrap: wrap; /* Allow the buttons to wrap when necessary */
            display: none; /* Initially hidden */

        }

        .hour-button {
            background-color: #007BFF;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: background-color 0.3s ease;
        }

        .hour-button:hover {
            background-color: #0056b3;
        }

        /* Floating Action Button */
        .fab {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: #007BFF;
            color: white;
            border: none;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
            font-size: 24px;
            transition: background-color 0.3s ease;
        }

        .fab:hover {
            background-color: #0056b3;
        }

        /* Card for displaying user data on the map */
        .user-info-card {
            background-color: #fff;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            position: absolute;
            bottom: 20px;
            left: 20px;
            width: 300px;
        }

        .user-info-card h3 {
            margin: 0;
            font-size: 18px;
            color: #333;
        }

        .user-info-card p {
            color: #777;
        }

        .centered-cell {
            text-align: center;
        }

        .fab {
            position: fixed;
            bottom: 20px;
            border: none;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-size: 28px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            cursor: pointer;
            transition: transform 0.2s ease;
            z-index: 1000;
        }

        .fab:hover {
            transform: scale(1.1);
        }

        .material-icons-outlined {
            font-size: 28px;
        }


        /* Close Button Styles */
        .close-btn {
            background-color: #f44336; /* Red background */
            color: white; /* White text */
            padding: 10px 20px; /* Padding for the button */
            border: none; /* Remove border */
            border-radius: 5px; /* Rounded corners */
            font-size: 16px; /* Font size */
            cursor: pointer; /* Pointer cursor on hover */
            transition: background-color 0.3s ease; /* Smooth background color transition */
        }

        /* Hover effect for the button */
        .close-btn:hover {
            background-color: #d32f2f; /* Darker red when hovered */
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            #map {
                height: 50vh;
            }

            .hour-button {
                padding: 8px 16px;
                font-size: 14px;
            }

            .user-info-card {
                width: 250px;
            }
        }
    </style>
</head>
<body>

<div id="map"></div>
<table id="userTable">
    <thead>
    <tr>
        <th>S.No</th>
        <th>Officer Name</th>
        <th>Email</th>
        <th>Bus No</th>
        <th>Distance From Destination</th>
        <th>ETA</th>
        <th>Tracking</th>
        <th>Status</th>
    </tr>
    </thead>
    <tbody id="userTableBody">
    <!-- Table data will be inserted here -->
    </tbody>
</table>

<div id="hourFilters"></div>

<!-- Filter Button (Timer Icon) -->
<button class="fab" onclick="toggleFilters()" style="right: 20px; background: #4CAF50;" title="Filter by Hours">
    <span class="material-icons-outlined">schedule</span>
</button>

<!-- Command Button (Megaphone/Command Icon) -->
<button class="fab" id="notificationBell" style="right: 90px; background: #673ab7;"
        title="Send Command or Orders">
    <span class="material-icons-outlined">campaign</span>
</button>

<!-- Upload Button (Upload Icon) -->
<button class="fab" id="masterDataUpload" onclick="openMasterDataModal()" style="right: 160px; background: #2196F3;"
        title="Upload CSV or Data">
    <span class="material-icons-outlined">upload</span>
</button>


<!-- Modal for Notifications -->
<!-- Notification Modal -->
<div id="notificationModal"
     style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.4); z-index:9999; justify-content:center; align-items:center;">
    <div id="modalContent"
         style="background:#fff; border-radius:16px; width:600px; max-width:95vw; padding:0; box-shadow:0 8px 32px rgba(0,0,0,0.2); position:relative;">
        <!-- Close Icon -->
        <button onclick="closeModal()"
                style="position:absolute; top:18px; right:24px; background:none; border:none; color:#888; font-size:32px; cursor:pointer; z-index:2;">
            &times;
        </button>
        <div style="display:flex; border-bottom:1px solid #eee;">
            <button id="tabIC"
                    style="flex:1; padding:20px; background:#f5f5f5; border:none; border-radius:16px 0 0 0; font-weight:bold; font-size:18px;">
                Information Centre
            </button>
            <button id="tabCC"
                    style="flex:1; padding:20px; background:#fff; border:none; border-radius:0 16px 0 0; font-weight:bold; font-size:18px;">
                Command Centre
            </button>
        </div>
        <div id="formIC" style="padding:32px;">
            <label style="font-weight:bold;">Enter message:</label>
            <textarea id="icMessage"
                      rows="4"
                      style="width:100%; margin-top:8px; border-radius:8px; border:1px solid #ccc; padding:12px; font-size:16px;"></textarea>
            <button onclick="submitIC()"
                    style="margin-top:24px; background:#007BFF; color:#fff; border:none; border-radius:8px; padding:14px 0; width:100%; font-weight:bold; font-size:16px;">
                Send Notification
            </button>
        </div>
        <div id="formCC" style="display:none; padding:32px;">
            <label style="font-weight:bold;">Enter message:</label>
            <textarea id="ccMessage"
                      rows="3"
                      style="width:100%; margin-top:8px; border-radius:8px; border:1px solid #ccc; padding:12px; font-size:16px;"></textarea>
            <div style="display:flex; gap:12px; margin-top:16px;">
                <input id="latitude" placeholder="Latitude" step="any"
                       style="flex:1; border-radius:8px; border:1px solid #ccc; padding:12px; font-size:16px;"
                       type="number">
                <input id="longitude" placeholder="Longitude" step="any"
                       style="flex:1; border-radius:8px; border:1px solid #ccc; padding:12px; font-size:16px;"
                       type="number">
            </div>
            <button onclick="submitCC()"
                    style="margin-top:24px; background:#28a745; color:#fff; border:none; border-radius:8px; padding:14px 0; width:100%; font-weight:bold; font-size:16px;">
                Send Command
            </button>
        </div>
        <!-- Close Button at Bottom -->
        <div style="padding:0 32px 32px 32px; text-align:right;">
            <button onclick="closeModal()"
                    style="background:#eee; color:#333; border:none; border-radius:6px; padding:10px 24px; font-size:15px; margin-top:8px;">
                Close
            </button>
        </div>
    </div>
</div>

<!-- Modal for Master Data Upload -->
<!-- Master Data Upload Modal -->
<div id="masterDataModal"
     style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.4); z-index:9999; justify-content:center; align-items:center;">
    <div id="modalContent_md"
         style="background:#fff; border-radius:16px; width:600px; max-width:95vw; padding:0; box-shadow:0 8px 32px rgba(0,0,0,0.2); position:relative;">
        <!-- Close Icon -->
        <button onclick="closeModal()"
                style="position:absolute; top:18px; right:24px; background:none; border:none; color:#888; font-size:32px; cursor:pointer; z-index:2;">
            &times;
        </button>
        <div style="display:flex; border-bottom:1px solid #eee;">
            <button id="tabIC_md"
                    style="flex:1; padding:20px; background:#f5f5f5; border:none; border-radius:16px 0 0 0; font-weight:bold; font-size:18px;">
                Information Centre
            </button>
            <button id="tabCC_md"
                    style="flex:1; padding:20px; background:#fff; border:none; border-radius:0 16px 0 0; font-weight:bold; font-size:18px;">
                Command Centre
            </button>
        </div>
        <div id="formIC_md" style="padding:32px;">
            <label style="font-weight:bold;">Enter message:</label>
            <textarea id="icMessage_md"
                      rows="4"
                      style="width:100%; margin-top:8px; border-radius:8px; border:1px solid #ccc; padding:12px; font-size:16px;"></textarea>
            <button onclick="submitIC()"
                    style="margin-top:24px; background:#007BFF; color:#fff; border:none; border-radius:8px; padding:14px 0; width:100%; font-weight:bold; font-size:16px;">
                Send Notification
            </button>
        </div>
        <div id="formCC_md" style="display:none; padding:32px;">
            <label style="font-weight:bold;">Enter message:</label>
            <textarea id="ccMessage_md"
                      rows="3"
                      style="width:100%; margin-top:8px; border-radius:8px; border:1px solid #ccc; padding:12px; font-size:16px;"></textarea>
            <div style="display:flex; gap:12px; margin-top:16px;">
                <input id="latitude_md" placeholder="Latitude" step="any"
                       style="flex:1; border-radius:8px; border:1px solid #ccc; padding:12px; font-size:16px;"
                       type="number">
                <input id="longitude_md" placeholder="Longitude" step="any"
                       style="flex:1; border-radius:8px; border:1px solid #ccc; padding:12px; font-size:16px;"
                       type="number">
            </div>
            <button onclick="submitCC()"
                    style="margin-top:24px; background:#28a745; color:#fff; border:none; border-radius:8px; padding:14px 0; width:100%; font-weight:bold; font-size:16px;">
                Send Command
            </button>
        </div>
        <!-- Close Button at Bottom -->
        <div style="padding:0 32px 32px 32px; text-align:right;">
            <button onclick="closeModal()"
                    style="background:#eee; color:#333; border:none; border-radius:6px; padding:10px 24px; font-size:15px; margin-top:8px;">
                Close
            </button>
        </div>
    </div>
</div>

<script>

    window.onload = function () {
        createHourButtons();  // Create hour buttons when the page loads
        initMap();  // Initialize the map
        connectWebSocket();  // Connect to WebSocket for real-time updates
    };
    // Close modal on Escape key
    document.addEventListener('keydown', function (event) {
        if (event.key === "Escape") {
            closeModal();
        }
    });

    let map;
    let users = [];
    let markers = [];
    let polylines = [];
    let startMarkers = [];
    let stompClient = null;
    let destinationMarker = null;
    let routePolylines = [];
    let directionsService = null;

    function initMap() {
        map = new google.maps.Map(document.getElementById("map"), {
            zoom: 10,
            center: {lat: 26.8467, lng: 80.9462},
        });
        fetchUsers(2);  // Fetch users when the page loads
        fetchMcNotifications(); // <-- call here

    }

    function fetchUsers(hours) {
        fetch(`/data/get-users?hours=${hours}`)
            .then(response => response.json())
            .then(data => {
                users = data;
                displayUsersOnTable();
                plotUsersOnMap();
            })
            .catch(error => console.error('Error fetching user data:', error));
    }

    function fetchMcNotifications() {
        // Fetch all notifications from your backend API
        fetch('/data/notifications')
            .then(response => response.json())
            .then(data => {
                // Check if 'data' is an array before calling filter
                if (Array.isArray(data)) {
                    console.log("Bhak mc", data); // Log the data to check the response structure

                    // Find the latest "CC" notification
                    const ccNotifications = data.filter(n => n.type === "CC");
                    if (ccNotifications.length === 0) return;

                    // Sort by timestamp (assuming Firestore timestamp is in n.timestamp)
                    ccNotifications.sort((a, b) => {
                        // If timestamp is a Firestore Timestamp object, convert to millis
                        const ta = a.timestamp?.seconds ? a.timestamp.seconds : new Date(a.timestamp).getTime();
                        const tb = b.timestamp?.seconds ? b.timestamp.seconds : new Date(b.timestamp).getTime();
                        return tb - ta;
                    });

                    const latestCC = ccNotifications[0];
                    const destLat = parseFloat(latestCC.latitude);
                    const destLng = parseFloat(latestCC.longitude);
                    plotDestinationAndRoutes(destLat, destLng); // Use your existing function
                } else {
                    console.error("Data is not an array:", data);
                }
            })
            .catch(error => {
                console.error("Error fetching notifications:", error);
            });


    }


    function plotDestinationAndRoutes(destLat, destLng) {
        // 2. Plot destination marker with "D" icon
        if (destinationMarker) destinationMarker.setMap(null);
        const dIcon = {
            url: 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 32 32"><circle cx="16" cy="16" r="14" fill="orange"/><text x="16" y="22" font-size="18" text-anchor="middle" fill="white" font-family="Arial" font-weight="bold">D</text></svg>',
            scaledSize: new google.maps.Size(32, 32)
        };
        destinationMarker = new google.maps.Marker({
            position: {lat: destLat, lng: destLng},
            map: map,
            icon: dIcon,
            title: "Destination"
        });
        map.setCenter({lat: destLat, lng: destLng});
        map.setZoom(13);

        // 3. Remove old polylines
        routePolylines.forEach(poly => poly.setMap(null));
        routePolylines = [];

        // 4. For each user, calculate and draw route
        directionsService = new google.maps.DirectionsService();
        users.forEach(user => {
            if (!user.locationHistory || user.locationHistory.length === 0) return;
            const lastLoc = user.locationHistory[user.locationHistory.length - 1];
            const userLatLng = {lat: lastLoc.latitude, lng: lastLoc.longitude};
            const destLatLng = {lat: destLat, lng: destLng};
            console.log("ye rha user ka lat lng", userLatLng);
            console.log("ye rha destination ka lat lng", destLatLng);

            directionsService.route({
                origin: userLatLng,
                destination: destLatLng,
                travelMode: google.maps.TravelMode.DRIVING
            }, (result, status) => {
                console.log("result", result);
                console.log("status mc", status);
                if (status === "OK") {
                    // 5. Draw polyline in light green
                    const routePath = result.routes[0].overview_path;
                    const polyline = new google.maps.Polyline({
                        path: routePath,
                        geodesic: true,
                        strokeColor: "#04400c", // light green
                        strokeOpacity: 0.9,
                        strokeWeight: 5,
                        map: map
                    });
                    routePolylines.push(polyline);

                    // 6. On polyline click, show info window with time/distance
                    const leg = result.routes[0].legs[0];
                    user.distance = leg.distance.text;
                    user.eta = leg.duration.text;

                    const infoContent = `
                    <div>
                        <b>User:</b> ${user.name}<br>
                        <b>Distance:</b> ${leg.distance.text}<br>
                        <b>Estimated Time:</b> ${leg.duration.text}
                    </div>
                `;
                    const infoWindow = new google.maps.InfoWindow();
                    polyline.addListener('click', function (e) {
                        infoWindow.setContent(infoContent);
                        infoWindow.setPosition(e.latLng);
                        infoWindow.open(map);
                    });

                    // Re-render the table with updated info
                    displayUsersOnTable();
                }
            });
        });
    }

    function displayUsersOnTable() {
        const tableBody = document.getElementById('userTableBody');

        // Clear the existing table data
        tableBody.innerHTML = '';

        // Ensure we are properly checking for the user data before inserting
        if (users.length > 0) {
            // Loop through the users and add rows
            users.forEach((user, index) => {
                const tr = document.createElement('tr');

                // Set background color based on user tracking status
                const statusColor = user.tracking ? 'lightgreen' : 'lightcoral'; // lightgreen for active, lightcoral for inactive
                const statusText = user.tracking ? 'ACTIVE' : 'INACTIVE'; // Status text

                tr.innerHTML = `
            <td class="centered-cell">${index + 1}</td>
            <td class="centered-cell" >${user.name}</td>
            <td class="centered-cell">${user.email}</td>
            <td class="centered-cell">${user.busNo}</td>
            <td class="centered-cell">${user.distance || 'Calculating...'}</td>
            <td class="centered-cell">${user.eta || 'Calculating...'}</td>
            <td class="centered-cell">${user.tracking ? 'Yes' : 'No'}</td>
            <td class="centered-cell" style="background-color: ${statusColor};">${statusText}</td>
        `;
                tableBody.appendChild(tr);
            });
        } else {
            // If no users found, add a message to the table
            const tr = document.createElement('tr');
            tr.innerHTML = `<td colspan="5" style="text-align: center;">No users found</td>`;
            tableBody.appendChild(tr);
        }
    }


    function plotUsersOnMap() {
        markers.forEach(marker => marker.setMap(null));
        markers = [];
        startMarkers.forEach(marker => marker.setMap(null));
        startMarkers = [];
        polylines.forEach(polyline => polyline.setMap(null));
        polylines = [];

        if (window.clusterer) {
            window.clusterer.clearMarkers();
        }

        users.forEach(user => {
            if (user.locationHistory && user.locationHistory.length > 0) {
                const startLocation = user.locationHistory[0];
                const endLocation = user.locationHistory[user.locationHistory.length - 1];

                const activeIcon = {
                    url: 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" fill="green" /><text x="12" y="16" font-size="12" text-anchor="middle" fill="white">A</text></svg>',
                    scaledSize: new google.maps.Size(24, 24),
                };
                const inactiveIcon = {
                    url: 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" fill="red" /><text x="12" y="16" font-size="12" text-anchor="middle" fill="white">I</text></svg>',
                    scaledSize: new google.maps.Size(24, 24),
                };
                const startIcon = {
                    url: 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" fill="blue" /><text x="12" y="16" font-size="12" text-anchor="middle" fill="white">S</text></svg>',
                    scaledSize: new google.maps.Size(24, 24),
                };

                // const startMarker = new google.maps.Marker({
                //     position: {lat: startLocation.latitude, lng: startLocation.longitude},
                //     map: map,
                //     title: `${user.name} - Start`,
                //     label: 'S',
                //     icon: startIcon
                // });
                // startMarkers.push(startMarker);

                const endMarker = new google.maps.Marker({
                    position: {lat: endLocation.latitude, lng: endLocation.longitude},
                    title: `Officer - ${user.name}`,
                    // label: `${user.name}`,
                    icon: user.tracking ? activeIcon : inactiveIcon,
                    map: map
                });
                markers.push(endMarker);

                const pathCoordinates = user.locationHistory.map(loc => ({
                    lat: loc.latitude,
                    lng: loc.longitude
                }));
                const polyline = new google.maps.Polyline({
                    path: pathCoordinates,
                    geodesic: true,
                    strokeColor: '#FF0000',
                    strokeOpacity: 1.0,
                    strokeWeight: 2,
                });
                polyline.setMap(map);
                polylines.push(polyline);
            }
        });

        window.clusterer = new MarkerClusterer(map, markers, {
            imagePath: 'https://developers.google.com/maps/documentation/javascript/examples/markerclusterer/m',
            gridSize: 60,
            maxZoom: 15
        });
    }

    function createHourButtons() {
        const container = document.getElementById("hourFilters");
        container.innerHTML = "";  // Clear previous buttons if any

        for (let i = 1; i <= 24; i++) {
            const button = document.createElement("button");
            button.textContent = `${i} Hour${i > 1 ? "s" : ""}`;
            button.classList.add("hour-button");
            button.onclick = function () {
                fetchUsers(i);
            };
            container.appendChild(button);
        }
    }

    function toggleFilters() {
        const filters = document.getElementById("hourFilters");
        const toggleButton = document.querySelector(".fab");

        // If the hour filters are currently visible, hide them and change button to "+"
        if (filters.style.display === "flex") {
            filters.style.display = "none";
            toggleButton.innerHTML = "+"; // Change the button to "+"
        } else {
            filters.style.display = "flex";
            toggleButton.innerHTML = "−"; // Change the button to "−"
        }
    }

    // WebSocket Real-Time Update Section
    function connectWebSocket() {
        // Determine the WebSocket URL based on the environment (localhost vs production)
        const wsUrl = window.location.hostname === 'localhost'
            ? 'http://localhost:9090/ws-location' // For local development
            : 'https://uppolice.gccloud.in/ws-location'; // For production
        const socket = new SockJS(wsUrl);
        stompClient = Stomp.over(socket);
        stompClient.connect({}, function (frame) {
            console.log('Connected: ' + frame);
            stompClient.subscribe('/topic/location', function (message) {
                const updatedUser = JSON.parse(message.body);
                updateUserInList(updatedUser);
                displayUsersOnTable();
                plotUsersOnMap();
                fetchMcNotifications(); // <-- call here
            });
        });
    }

    // Helper to update or add the user in your users array
    function updateUserInList(updatedUser) {
        const idx = users.findIndex(u => u.docId === updatedUser.docId);
        if (idx !== -1) {
            console.log("ye mila hai naya user ");
            console.log("all users: ", users);
            users[idx] = updatedUser;
        } else {
            users.push(updatedUser);
        }
    }


</script>


<script>

    // Modal logic
    document.getElementById('masterDataUpload').onclick = function () {
        document.getElementById('masterDataUpload').style.display = 'flex';
        showTab('IC');
    };

    function closeMasterDataModal() {
        document.getElementById('masterDataUpload').style.display = 'none';
    }

    // Modal logic
    document.getElementById('notificationBell').onclick = function () {
        document.getElementById('notificationModal').style.display = 'flex';
        showTab('IC');
    };

    function closeModal() {
        document.getElementById('notificationModal').style.display = 'none';
    }

    document.getElementById('tabIC').onclick = function () {
        showTab('IC');
    };
    document.getElementById('tabCC').onclick = function () {
        showTab('CC');
    };

    function showTab(tab) {
        document.getElementById('formIC').style.display = tab === 'IC' ? 'block' : 'none';
        document.getElementById('formCC').style.display = tab === 'CC' ? 'block' : 'none';
        document.getElementById('tabIC').style.background = tab === 'IC' ? '#f5f5f5' : '#fff';
        document.getElementById('tabCC').style.background = tab === 'CC' ? '#f5f5f5' : '#fff';
    }

    // Submit Information Centre
    function submitIC() {
        const message = document.getElementById('icMessage').value.trim();
        if (!message) return alert('Please enter a message.');
        fetch('/data/sendNotification', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                type: 'IC',
                message: message
            })
        }).then(res => res.text()).then(msg => {
            alert(msg);
            closeModal();
        });
    }

    // Submit Command Centre
    function submitCC() {
        const message = document.getElementById('ccMessage').value.trim();
        const latitude = document.getElementById('latitude').value.trim();
        const longitude = document.getElementById('longitude').value.trim();
        if (!message || !latitude || !longitude) return alert('Please fill all fields.');
        fetch('/data/sendNotification', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                type: 'CC',
                message: message,
                latitude: latitude,
                longitude: longitude
            })
        }).then(res => res.text()).then(msg => {
            alert(msg);
            closeModal();
        });
    }
</script>
</body>
</html>
