<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet">

    <title>User Location Tracking</title>
    <script async
            defer
            src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAkyZ_KEJyO9abb8-TW96HaE-Uu_3q4IQw&callback=initMap"></script>
    <script src="https://cdn.jsdelivr.net/gh/googlemaps/v3-utility-library/markerclusterer/src/markerclusterer.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <style>
        /* General styles */
        body {
            font-family: 'Arial', sans-serif;
            background-color: #fafafa;
            margin: 0;
            padding: 0;
        }

        /* Container for map and table */
        #map {
            height: 60vh;
            width: 100%;
        }

        /* Table styles */
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            background-color: #fff;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        table, th, td {
            border: 1px solid #ddd;
            text-align: left;
            padding: 12px 15px;
        }

        th {
            background-color: #f1f1f1;
            color: #333;
        }

        tr:nth-child(even) {
            background-color: #f9f9f9;
        }

        /* Buttons and Filters */
        #hourFilters {
            position: fixed;
            bottom: 20px;
            right: 20px;
            display: flex;
            gap: 10px; /* Space between buttons */
            flex-wrap: wrap; /* Allow the buttons to wrap when necessary */
            display: none; /* Initially hidden */

        }

        .hour-button {
            background-color: #007BFF;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: background-color 0.3s ease;
        }

        .hour-button:hover {
            background-color: #0056b3;
        }

        /* Floating Action Button */
        .fab {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: #007BFF;
            color: white;
            border: none;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
            font-size: 24px;
            transition: background-color 0.3s ease;
        }

        .fab:hover {
            background-color: #0056b3;
        }

        /* Card for displaying user data on the map */
        .user-info-card {
            background-color: #fff;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            position: absolute;
            bottom: 20px;
            left: 20px;
            width: 300px;
        }

        .user-info-card h3 {
            margin: 0;
            font-size: 18px;
            color: #333;
        }

        .user-info-card p {
            color: #777;
        }

        .centered-cell {
            text-align: center;
        }

        .fab {
            position: fixed;
            bottom: 20px;
            border: none;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-size: 28px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            cursor: pointer;
            transition: transform 0.2s ease;
            z-index: 1000;
        }

        .fab:hover {
            transform: scale(1.1);
        }

        .material-icons-outlined {
            font-size: 28px;
        }


        /* Close Button Styles */
        .close-btn {
            background-color: #f44336; /* Red background */
            color: white; /* White text */
            padding: 10px 20px; /* Padding for the button */
            border: none; /* Remove border */
            border-radius: 5px; /* Rounded corners */
            font-size: 16px; /* Font size */
            cursor: pointer; /* Pointer cursor on hover */
            transition: background-color 0.3s ease; /* Smooth background color transition */
        }

        /* Hover effect for the button */
        .close-btn:hover {
            background-color: #d32f2f; /* Darker red when hovered */
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            #map {
                height: 50vh;
            }

            .hour-button {
                padding: 8px 16px;
                font-size: 14px;
            }

            .user-info-card {
                width: 250px;
            }
        }

        /* Bus Details Modal Styles */
        .bus-details-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .bus-details-content {
            background: white;
            width: 90%;
            max-width: 800px;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            padding: 24px;
            position: relative;
            max-height: 80vh;
            overflow-y: auto;
        }

        .bus-details-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .bus-details-title {
            font-size: 24px;
            font-weight: 600;
            color: #333;
        }

        .bus-details-close {
            background: none;
            border: none;
            font-size: 24px;
            color: #666;
            cursor: pointer;
            padding: 5px;
            transition: color 0.3s;
        }

        .bus-details-close:hover {
            color: #333;
        }

        .bus-details-grid {
            /* Remove grid for table layout */
            display: block;
            margin-top: 20px;
        }

        .bus-details-table {
            width: 100%;
            border-collapse: collapse;
            background: #f8f9fa;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .bus-details-table th, .bus-details-table td {
            padding: 14px 12px;
            text-align: left;
            font-size: 15px;
        }

        .bus-details-table th {
            background: #f1f1f1;
            color: #333;
            font-weight: 700;
            border-bottom: 2px solid #e0e0e0;
        }

        .bus-details-table tr:not(:last-child) td {
            border-bottom: 1px solid #e0e0e0;
        }

        .bus-details-table td {
            color: #444;
        }

        .bus-user-status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            margin-top: 0;
        }

        .status-active {
            background: #e8f5e9;
            color: #2e7d32;
        }

        .status-inactive {
            background: #ffebee;
            color: #c62828;
        }

        .clickable-bus {
            color: #007bff;
            cursor: pointer;
            text-decoration: underline;
            transition: color 0.2s;
        }

        .clickable-bus:hover {
            color: #0056b3;
        }

        .upload-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.4);
            z-index: 9999;
            justify-content: center;
            align-items: center;
        }

        .upload-modal-content {
            background: #fff;
            border-radius: 16px;
            width: 400px;
            max-width: 95vw;
            padding: 32px 28px 24px 28px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.18);
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: stretch;
            gap: 18px;
        }

        .upload-modal-close {
            position: absolute;
            top: 18px;
            right: 24px;
            background: none;
            border: none;
            color: #888;
            font-size: 32px;
            cursor: pointer;
            z-index: 2;
            transition: color 0.2s;
        }

        .upload-modal-close:hover {
            color: #333;
        }

        .upload-modal-title {
            font-size: 22px;
            font-weight: 700;
            color: #222;
            margin-bottom: 8px;
            text-align: center;
        }

        .upload-modal-label {
            font-weight: 500;
            margin-bottom: 6px;
            color: #444;
        }

        .upload-modal-input {
            padding: 10px 12px;
            border-radius: 8px;
            border: 1px solid #ccc;
            font-size: 16px;
            margin-bottom: 12px;
        }

        .upload-modal-btn {
            background: #2196F3;
            color: #fff;
            border: none;
            border-radius: 8px;
            padding: 12px 0;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 8px;
            transition: background 0.2s;
        }

        .upload-modal-btn:hover {
            background: #1769aa;
        }

        .upload-modal-feedback {
            margin-top: 10px;
            font-size: 15px;
            text-align: center;
        }

        .upload-modal-progress {
            margin-top: 8px;
            width: 100%;
            height: 6px;
            background: #e3e3e3;
            border-radius: 4px;
            overflow: hidden;
        }

        .upload-modal-progress-bar {
            height: 100%;
            background: #2196F3;
            width: 0;
            transition: width 0.3s;
        }
    </style>
</head>
<body>

<div id="map"></div>

<div id="summaryCard" style="width:100%;margin:24px 0 0 0;display:flex;justify-content:center;">
    <!-- Card content will be injected by JS -->
</div>

<table id="userTable">
    <thead>
    <tr>
        <th class="centered-cell">S.No</th>
        <th class="centered-cell">Bus No</th>
        <th class="centered-cell">Officer Name</th>
        <!--        <th class="centered-cell">Email</th>-->
        <th class="centered-cell">Distance From Destination</th>
        <th class="centered-cell">ETA</th>
        <th class="centered-cell">Tracking</th>
        <th class="centered-cell">Last Active At</th>
        <th class="centered-cell">Status</th>
    </tr>
    </thead>
    <tbody id="userTableBody">
    <!-- Table data will be inserted here -->
    </tbody>
</table>

<div id="hourFilters"></div>
<!--<div id="imageContainer"></div>-->


<!-- Filter Button (Timer Icon) -->
<button class="fab" onclick="toggleFilters()" style="right: 20px; background: #4CAF50;" title="Filter by Hours">
    <span class="material-icons-outlined">schedule</span>
</button>

<!-- Command Button (Megaphone/Command Icon) -->
<button class="fab" id="notificationBell" style="right: 90px; background: #673ab7;"
        title="Send Command or Orders">
    <span class="material-icons-outlined">campaign</span>
</button>

<!---------------------MODAL OF EXCEL Upload Button (Upload Icon) ---------------->
<button class="fab" id="masterDataUpload" style="right: 160px; background: #2196F3;"
        title="Upload CSV or Data">
    <span class="material-icons-outlined">upload</span>
</button>


<!-- Modal for Notifications -->
<!-- Notification Modal -->
<div id="notificationModal"
     style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.4); z-index:9999; justify-content:center; align-items:center;">
    <div id="modalContent"
         style="background:#fff; border-radius:16px; width:600px; max-width:95vw; padding:0; box-shadow:0 8px 32px rgba(0,0,0,0.2); position:relative;">
        <!-- Close Icon -->
        <button onclick="closeModal()"
                style="position:absolute; top:18px; right:24px; background:none; border:none; color:#888; font-size:32px; cursor:pointer; z-index:2;">
            &times;
        </button>
        <div style="display:flex; border-bottom:1px solid #eee;">
            <button id="tabIC"
                    style="flex:1; padding:20px; background:#f5f5f5; border:none; border-radius:16px 0 0 0; font-weight:bold; font-size:18px;">
                Information Centre
            </button>
            <button id="tabCC"
                    style="flex:1; padding:20px; background:#fff; border:none; border-radius:0 16px 0 0; font-weight:bold; font-size:18px;">
                Command Centre
            </button>
        </div>
        <div id="formIC" style="padding:32px;">
            <label style="font-weight:bold;">Enter message:</label>
            <textarea id="icMessage"
                      rows="4"
                      style="width:100%; margin-top:8px; border-radius:8px; border:1px solid #ccc; padding:12px; font-size:16px;"></textarea>
            <button onclick="submitIC()"
                    style="margin-top:24px; background:#007BFF; color:#fff; border:none; border-radius:8px; padding:14px 0; width:100%; font-weight:bold; font-size:16px;">
                Send Notification
            </button>
        </div>
        <div id="formCC" style="display:none; padding:32px;">
            <label style="font-weight:bold;">Enter message:</label>
            <textarea id="ccMessage"
                      rows="3"
                      style="width:100%; margin-top:8px; border-radius:8px; border:1px solid #ccc; padding:12px; font-size:16px;"></textarea>
            <div style="display:flex; gap:12px; margin-top:16px;">
                <input id="latitude" placeholder="Latitude" step="any"
                       style="flex:1; border-radius:8px; border:1px solid #ccc; padding:12px; font-size:16px;"
                       type="number">
                <input id="longitude" placeholder="Longitude" step="any"
                       style="flex:1; border-radius:8px; border:1px solid #ccc; padding:12px; font-size:16px;"
                       type="number">
            </div>
            <button onclick="submitCC()"
                    style="margin-top:24px; background:#28a745; color:#fff; border:none; border-radius:8px; padding:14px 0; width:100%; font-weight:bold; font-size:16px;">
                Send Command
            </button>
        </div>
        <!-- Close Button at Bottom -->
        <div style="padding:0 32px 32px 32px; text-align:right;">
            <button onclick="closeModal()"
                    style="background:#eee; color:#333; border:none; border-radius:6px; padding:10px 24px; font-size:15px; margin-top:8px;">
                Close
            </button>
        </div>
    </div>
</div>

<!-- Modal for Master Data Upload -->
<!-- Master Data Upload Modal -->
<div id="masterDataModal"
     style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.4); z-index:9999; justify-content:center; align-items:center;">
    <div id="modalContent_md"
         style="background:#fff; border-radius:16px; width:600px; max-width:95vw; padding:0; box-shadow:0 8px 32px rgba(0,0,0,0.2); position:relative;">
        <!-- Close Icon -->
        <button onclick="closeModal()"
                style="position:absolute; top:18px; right:24px; background:none; border:none; color:#888; font-size:32px; cursor:pointer; z-index:2;">
            &times;
        </button>
        <div style="display:flex; border-bottom:1px solid #eee;">
            <button id="tabIC_md"
                    style="flex:1; padding:20px; background:#f5f5f5; border:none; border-radius:16px 0 0 0; font-weight:bold; font-size:18px;">
                Information Centre
            </button>
            <button id="tabCC_md"
                    style="flex:1; padding:20px; background:#fff; border:none; border-radius:0 16px 0 0; font-weight:bold; font-size:18px;">
                Command Centre
            </button>
        </div>
        <div id="formIC_md" style="padding:32px;">
            <label style="font-weight:bold;">Enter message:</label>
            <textarea id="icMessage_md"
                      rows="4"
                      style="width:100%; margin-top:8px; border-radius:8px; border:1px solid #ccc; padding:12px; font-size:16px;"></textarea>
            <button onclick="submitIC()"
                    style="margin-top:24px; background:#007BFF; color:#fff; border:none; border-radius:8px; padding:14px 0; width:100%; font-weight:bold; font-size:16px;">
                Send Notification
            </button>
        </div>
        <div id="formCC_md" style="display:none; padding:32px;">
            <label style="font-weight:bold;">Enter message:</label>
            <textarea id="ccMessage_md"
                      rows="3"
                      style="width:100%; margin-top:8px; border-radius:8px; border:1px solid #ccc; padding:12px; font-size:16px;"></textarea>
            <div style="display:flex; gap:12px; margin-top:16px;">
                <input id="latitude_md" placeholder="Latitude" step="any"
                       style="flex:1; border-radius:8px; border:1px solid #ccc; padding:12px; font-size:16px;"
                       type="number">
                <input id="longitude_md" placeholder="Longitude" step="any"
                       style="flex:1; border-radius:8px; border:1px solid #ccc; padding:12px; font-size:16px;"
                       type="number">
            </div>
            <button onclick="submitCC()"
                    style="margin-top:24px; background:#28a745; color:#fff; border:none; border-radius:8px; padding:14px 0; width:100%; font-weight:bold; font-size:16px;">
                Send Command
            </button>
        </div>
        <!-- Close Button at Bottom -->
        <div style="padding:0 32px 32px 32px; text-align:right;">
            <button onclick="closeModal()"
                    style="background:#eee; color:#333; border:none; border-radius:6px; padding:10px 24px; font-size:15px; margin-top:8px;">
                Close
            </button>
        </div>
    </div>
</div>

<!-- Add this before the closing body tag -->
<div id="busDetailsModal" class="bus-details-modal">
    <div class="bus-details-content">
        <div class="bus-details-header">
            <h2 class="bus-details-title">Bus Details</h2>
            <button class="bus-details-close" onclick="closeBusDetailsModal()">&times;</button>
        </div>
        <div id="busDetailsContent" class="bus-details-grid">
            <!-- Content will be dynamically populated -->
        </div>
    </div>
</div>

<!-- Upload Modal -->
<div id="uploadModal" class="upload-modal">
    <div class="upload-modal-content">
        <button class="upload-modal-close" onclick="closeUploadModal()">&times;</button>
        <div class="upload-modal-title">Upload Master Data (CSV/Excel)</div>
        <label class="upload-modal-label" for="masterDataFile">Select File (.csv, .xls, .xlsx):</label>
        <input class="upload-modal-input" type="file" id="masterDataFile"
               accept=".csv, application/vnd.ms-excel, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet">
        <button class="upload-modal-btn" onclick="uploadMasterData()">Upload</button>
        <div class="upload-modal-progress" id="uploadProgress" style="display:none;">
            <div class="upload-modal-progress-bar" id="uploadProgressBar"></div>
        </div>
        <div class="upload-modal-feedback" id="uploadFeedback"></div>
    </div>
</div>

<script>

    window.onload = function () {
        createHourButtons();  // Create hour buttons when the page loads
        initMap();  // Initialize the map
        connectWebSocket();  // Connect to WebSocket for real-time updates
    };
    // Close modal on Escape key
    document.addEventListener('keydown', function (event) {
        if (event.key === "Escape") {
            closeModal();
        }
    });

    let map;
    let users = [];
    let markers = [];
    let polylines = [];
    let startMarkers = [];
    let stompClient = null;
    let destinationMarker = null;
    let routePolylines = [];
    let directionsService = null;

    function initMap() {
        map = new google.maps.Map(document.getElementById("map"), {
            zoom: 10,
            center: {lat: 26.8467, lng: 80.9462},
        });
        fetchUsers(2);  // Fetch users when the page loads
        fetchMcNotifications(); // <-- call here

    }

    function fetchUsers(hours) {
        fetch(`/data/get-users?hours=${hours}`)
            .then(response => response.json())
            .then(data => {
                users = data;
                displayUsersOnTable();
                plotUsersOnMap();
                renderSummaryCard();

            })
            .catch(error => console.error('Error fetching user data:', error));
    }

    //------------------START This function fetches the latest "CC" notification and plots the destination and routes------------------

    function fetchMcNotifications() {
        // Fetch all notifications from your backend API
        fetch('/data/notifications')
            .then(response => response.json())
            .then(data => {
                // Check if 'data' is an array before calling filter
                if (Array.isArray(data)) {
                    console.log("Bhak mc", data); // Log the data to check the response structure

                    // Find the latest "CC" notification
                    const ccNotifications = data.filter(n => n.type === "CC");
                    if (ccNotifications.length === 0) return;

                    // Sort by timestamp (assuming Firestore timestamp is in n.timestamp)
                    ccNotifications.sort((a, b) => {
                        // If timestamp is a Firestore Timestamp object, convert to millis
                        const ta = a.timestamp?.seconds ? a.timestamp.seconds : new Date(a.timestamp).getTime();
                        const tb = b.timestamp?.seconds ? b.timestamp.seconds : new Date(b.timestamp).getTime();
                        return tb - ta;
                    });

                    const latestCC = ccNotifications[0];
                    const destLat = parseFloat(latestCC.latitude);
                    const destLng = parseFloat(latestCC.longitude);
                    plotDestinationAndRoutes(destLat, destLng); // Use your existing function
                } else {
                    console.error("Data is not an array:", data);
                }
            })
            .catch(error => {
                console.error("Error fetching notifications:", error);
            });


    }

    //------------------END This function fetches the latest "CC" notification and plots the destination and routes------------------

    //------------------START This function plots the destination and routes for all users------------------

    function plotDestinationAndRoutes(destLat, destLng) {
        // 2. Plot destination marker with "D" icon
        if (destinationMarker) destinationMarker.setMap(null);
        const dIcon = {
            url: '/images/location_10813380.png', // Path relative to the static folder
            scaledSize: new google.maps.Size(32, 32)
        };
        destinationMarker = new google.maps.Marker({
            position: {lat: destLat, lng: destLng},
            map: map,
            icon: dIcon,
            title: "Destination"
        });
        // Just Commented this line to not center the map on destination and Automatically zoom to the DESTINATION
        // map.setCenter({lat: destLat, lng: destLng});
        // map.setZoom(13);

        // 3. Remove old polylines
        routePolylines.forEach(poly => poly.setMap(null));
        routePolylines = [];

        // 4. For each user, calculate and draw route
        directionsService = new google.maps.DirectionsService();
        users.forEach(user => {
            if (!user.locationHistory || user.locationHistory.length === 0) return;
            const lastLoc = user.locationHistory[user.locationHistory.length - 1];
            const userLatLng = {lat: lastLoc.latitude, lng: lastLoc.longitude};
            const destLatLng = {lat: destLat, lng: destLng};
            console.log("ye rha user ka lat lng", userLatLng);
            console.log("ye rha destination ka lat lng", destLatLng);

            directionsService.route({
                origin: userLatLng,
                destination: destLatLng,
                travelMode: google.maps.TravelMode.DRIVING
            }, (result, status) => {
                console.log("result", result);
                console.log("status mc", status);
                if (status === "OK") {
                    // 5. Draw polyline in light green
                    const routePath = result.routes[0].overview_path;
                    const polyline = new google.maps.Polyline({
                        path: routePath,
                        geodesic: true,
                        strokeColor: "#0a87f5", // light green
                        strokeOpacity: 0.9,
                        strokeWeight: 5,
                        map: map
                    });
                    routePolylines.push(polyline);

                    // 6. On polyline click, show info window with time/distance
                    const leg = result.routes[0].legs[0];
                    user.distance = leg.distance.text;
                    user.eta = leg.duration.text;

                    const infoContent = `
                    <div>
                        <b>User:</b> ${user.name}<br>
                        <b>Distance:</b> ${leg.distance.text}<br>
                        <b>Estimated Time:</b> ${leg.duration.text}
                    </div>
                `;
                    const infoWindow = new google.maps.InfoWindow();
                    polyline.addListener('click', function (e) {
                        infoWindow.setContent(infoContent);
                        infoWindow.setPosition(e.latLng);
                        infoWindow.open(map);
                    });

                    // Re-render the table with updated info
                    displayUsersOnTable();
                }
            });
        });
    }

    function formatDateTime(dateString) {
        if (!dateString || dateString === '-') return '-';
        // Handles both ISO and Date.toString() formats
        let date = new Date(dateString);
        if (isNaN(date.getTime())) return dateString; // fallback if parsing fails

        // Format: DD-MM-YYYY HH:mm:ss (24-hour)
        let day = String(date.getDate()).padStart(2, '0');
        let month = String(date.getMonth() + 1).padStart(2, '0');
        let year = date.getFullYear();
        let hours = String(date.getHours()).padStart(2, '0');
        let mins = String(date.getMinutes()).padStart(2, '0');
        let secs = String(date.getSeconds()).padStart(2, '0');
        return `${day}-${month}-${year} ${hours}:${mins}:${secs}`;
    }


    function focusUserOnMap(docId) {

        console.log("docId to focus on map:", docId);
        // Close all open InfoWindows first
        Object.values(infoWindowMap).forEach(iw => iw.close());

        const marker = markerMap[docId];
        const infoWindow = infoWindowMap[docId];
        if (marker && infoWindow) {
            map.setCenter(marker.getPosition());
            map.setZoom(15); // Optional: zoom in
            infoWindow.open(map, marker);
        }
    }


    //------------------END This function plots the destination and routes for all users------------------

    function displayUsersOnTable() {
        const tableBody = document.getElementById('userTableBody');
        tableBody.innerHTML = '';

        if (users.length > 0) {
            users.forEach((user, index) => {
                const tr = document.createElement('tr');
                const statusColor = user.tracking ? 'lightgreen' : 'lightcoral';
                const statusText = user.tracking ? 'ACTIVE' : 'INACTIVE';
                const busNo = user.busNo ? user.busNo : 'NA';

                tr.innerHTML = `
                    <td class="centered-cell">${index + 1}</td>
                    <td class="centered-cell">
                        <span class="clickable-bus" onclick="showBusDetails('${busNo}')">${busNo}</span>
                    </td>
                    <td class="centered-cell">
                        <a href="#" onclick="focusUserOnMap('${user.registration_no}'); return false;" style="color:#007bff;cursor:pointer;text-decoration:underline;">
                            ${user.name}
                        </a>
                    </td>
                    <td class="centered-cell">${user.distance || 'Calculating...'}</td>
                    <td class="centered-cell">${user.eta || 'Calculating...'}</td>
                    <td class="centered-cell">${user.tracking ? 'Yes' : 'No'}</td>
                    <td class="centered-cell">${formatDateTime(user.lastActiveAt) || '-'}</td>
                    <td class="centered-cell" style="background-color: ${statusColor};">${statusText}</td>
                `;
                tableBody.appendChild(tr);
            });
        } else {
            const tr = document.createElement('tr');
            tr.innerHTML = `<td colspan="9" style="text-align: center;">No users found</td>`;
            tableBody.appendChild(tr);
        }
    }

    // ---------STARTS This function plots users on the map with their start and end locations, and draws polylines for their location history. It also uses MarkerClusterer to group markers.---------

    let markerMap = {};      // user.registration_no -> marker
    let infoWindowMap = {};  // user.registration_no -> infoWindow

    function plotUsersOnMap() {
        markers.forEach(marker => marker.setMap(null));
        markers = [];
        polylines.forEach(polyline => polyline.setMap(null));
        polylines = [];
        if (window.clusterer) {
            window.clusterer.clearMarkers();
        }
        markerMap = {};
        infoWindowMap = {};

        users.forEach(user => {
            if (user.locationHistory && user.locationHistory.length > 0) {
                const endLocation = user.locationHistory[user.locationHistory.length - 1];

                // --------------BASICALLY THIS IS THE STARTING POINT OF THE JOURNEY--------------
                // Add a marker at the starting location (if journey has more than 1 point)
                if (user.locationHistory.length > 1) {
                    const startLoc = user.locationHistory[0];
                    const startIcon = {
                        url: '/images/JOURNEY_START_POINT.png', // Use your start icon here
                        scaledSize: new google.maps.Size(32, 32),
                    };
                    const startMarker = new google.maps.Marker({
                        position: { lat: startLoc.latitude, lng: startLoc.longitude },
                        icon: startIcon,
                        map: map
                    });
                    markers.push(startMarker); // So you can clear it later
                }


                // --------------BASICALLY THIS IS THE LATEST POINT OF THE CURRENT USER I MEAN WHERE JE HAS STOPPED--------------
                // Add a pin at the previous location (if exists)
                const historyLength = user.locationHistory.length;
                if (historyLength > 1) {
                    
                    const prevLoc = user.locationHistory[historyLength - 2];
                    const pinIcon = {
                        url: '/images/LAST_PINNED_BUS_LOCATION.png', // Use your pin icon here
                        scaledSize: new google.maps.Size(32, 32),
                    };
                    const pinMarker = new google.maps.Marker({
                        position: {lat: prevLoc.latitude, lng: prevLoc.longitude},
                        icon: pinIcon,
                        map: map
                    });
                    markers.push(pinMarker); // So you can clear it later
                }

                // Use a bus icon for all markers
                const busActiveIcon = {
                    url: '/images/ACTIVE_BUS.png', // Make sure this image exists in your static/images folder
                    scaledSize: new google.maps.Size(40, 40),
                };
                const busInActiveIcon = {
                    url: '/images/INACTIVE_BUS.png', // Make sure this image exists in your static/images folder
                    scaledSize: new google.maps.Size(40, 40),
                };

                const marker = new google.maps.Marker({
                    position: {lat: endLocation.latitude, lng: endLocation.longitude},
                    title: `Officer - ${user.name}`,
                    icon: user.tracking ? busActiveIcon : busInActiveIcon,
                    map: map
                });
                markers.push(marker);
                // <tr>
                //     <td style="font-weight:bold; color:#333; padding:4px 8px;">Email</td>
                //     <td style="padding:4px 8px;">${user.email}</td>
                // </tr>
                const infoContent = `
                <div style="min-width:220px; font-family: Arial, sans-serif;">
    <table style="width:100%; border-collapse:collapse;">
        <tr>
            <td style="font-weight:bold; color:#333; padding:4px 8px;">User Name</td>
            <td style="padding:4px 8px;">${user.name}</td>
        </tr>
        <tr>
            <td style="font-weight:bold; color:#333; padding:4px 8px;">Status</td>
            <td style="padding:4px 8px;">
                <span style="font-weight:bold; color:${user.tracking ? '#388e3c' : '#d32f2f'};">
                    ${user.tracking ? 'ACTIVE' : 'INACTIVE'}
                </span>
            </td>
        </tr>
        <tr>
            <td style="font-weight:bold; color:#333; padding:4px 8px;">Last Active At</td>
            <td style="padding:4px 8px;">${formatDateTime(user.lastActiveAt)}</td>
        </tr>

       <tr>
    <td style="font-weight:bold; color:#333; padding:4px 8px;">Bus No</td>
    <td style="padding:4px 8px;">${user.busNo && user.busNo !== "undefined" && user.busNo !== "" ? user.busNo : 'NA'}</td>
</tr>
    </table>
</div>
            `;
                const infoWindow = new google.maps.InfoWindow({
                    content: infoContent
                });

                // Do NOT open by default!
                // infoWindow.open(map, marker);

                // Allow reopening on marker click
                marker.addListener('click', function () {
                    infoWindow.open(map, marker);
                });

                // Store marker and infoWindow for later access (use docId for uniqueness)
                markerMap[user.registration_no] = marker;
                infoWindowMap[user.registration_no] = infoWindow;

                // Draw polyline for user's path
                const pathCoordinates = user.locationHistory.map(loc => ({
                    lat: loc.latitude,
                    lng: loc.longitude
                }));
                const polyline = new google.maps.Polyline({
                    path: pathCoordinates,
                    geodesic: true,
                    strokeColor: '#FF0000',
                    strokeOpacity: 1.0,
                    strokeWeight: 2,
                });
                polyline.setMap(map);
                polylines.push(polyline);
            }
        });

        window.clusterer = new MarkerClusterer(map, markers, {
            imagePath: 'https://developers.google.com/maps/documentation/javascript/examples/markerclusterer/m',
            gridSize: 60,
            maxZoom: 15
        });
    }

    // ---------END This function plots users on the map with their start and end locations, and draws polylines for their location history. It also uses MarkerClusterer to group markers.---------

    function createHourButtons() {
        const container = document.getElementById("hourFilters");
        container.innerHTML = "";  // Clear previous buttons if any

        for (let i = 1; i <= 24; i++) {
            const button = document.createElement("button");
            button.textContent = `${i} Hour${i > 1 ? "s" : ""}`;
            button.classList.add("hour-button");
            button.onclick = function () {
                fetchUsers(i);
            };
            container.appendChild(button);
        }
    }

    function toggleFilters() {
        const filters = document.getElementById("hourFilters");
        const toggleButton = document.querySelector(".fab");

        // If the hour filters are currently visible, hide them and change button to "+"
        if (filters.style.display === "flex") {
            filters.style.display = "none";
            toggleButton.innerHTML = "+"; // Change the button to "+"
        } else {
            filters.style.display = "flex";
            toggleButton.innerHTML = "−"; // Change the button to "−"
        }
    }

    // WebSocket Real-Time Update Section
    function connectWebSocket() {
        // Determine the WebSocket URL based on the environment (localhost vs production)
        const wsUrl = window.location.hostname === 'localhost'
            ? 'http://localhost:9090/ws-location' // For local development
            : 'https://uppolice.gccloud.in/ws-location'; // For production
        const socket = new SockJS(wsUrl);
        stompClient = Stomp.over(socket);
        stompClient.connect({}, function (frame) {
            console.log('Connected: ' + frame);
            stompClient.subscribe('/topic/location', function (message) {
                const updatedUser = JSON.parse(message.body);
                console.log("Received updated user from WebSocket:", updatedUser);

                updateUserInList(updatedUser);
                displayUsersOnTable();
                plotUsersOnMap();
                fetchMcNotifications(); // <-- call here
                renderSummaryCard();

            });
        });
    }

    //------------START Main LOGIC IS HERE Helper to update or add the user in your users array----------------------
    function updateUserInList(updatedUser) {
        const idx = users.findIndex(u => u.registration_no === updatedUser.registration_no);
        if (idx !== -1) {
            // Merge location history
            const existingUser = users[idx];
            const existingHistory = existingUser.locationHistory || [];
            const newHistory = updatedUser.locationHistory || [];

            // Merge and deduplicate by timestamp (assuming timestamp is unique)
            const allHistory = [...existingHistory, ...newHistory];
            // Remove duplicates
            const seen = new Set();
            const uniqueHistory = [];
            for (const loc of allHistory) {
                if (!loc.timestamp || !seen.has(loc.timestamp)) {
                    uniqueHistory.push(loc);
                    if (loc.timestamp) seen.add(loc.timestamp);
                }
            }
            // Sort by timestamp ascending
            uniqueHistory.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));

            // Update user
            users[idx] = {
                ...existingUser,
                ...updatedUser,
                locationHistory: uniqueHistory
            };
        } else {
            users.push(updatedUser);
        }
    }

    //------------END Main LOGIC IS HERE Helper to update or add the user in your users array----------------------


    function renderSummaryCard() {
        // Calculate stats
        const totalUsers = users.length;
        const allBuses = users
            .map(u => u.busNo)
            .filter(busNo => busNo && busNo !== "undefined");
        const totalActive = users.filter(u => u.tracking).length;
        const totalInactive = totalUsers - totalActive;
        const uniqueBuses = [...new Set(allBuses)];
        const totalBuses = allBuses.length;
        const totalUniqueBuses = uniqueBuses.length;

        // <div><b>Total Officers Tracked:</b> ${totalUsers}</div>
        // Card HTML
        document.getElementById('summaryCard').innerHTML = `
        <div style="
            display:flex;
            gap:32px;
            background:#fff;
            border-radius:12px;
            box-shadow:0 2px 10px rgba(0,0,0,0.08);
            padding:18px 32px;
            font-size:17px;
            font-family:Arial,sans-serif;
            margin-bottom:12px;
            flex-wrap:wrap;
        ">

            <div><b>Current Active Buses:</b> <span style="color:#388e3c;font-weight:bold;">${totalActive}</span></div>
            <div><b>Current Inactive Buses:</b> <span style="color:#d32f2f;font-weight:bold;">${totalInactive}</span></div>
            <div><b>Total Buses Monitored:</b> ${totalUniqueBuses}</div>
        </div>
    `;
    }

    // SAMARTH --------------
    // fetch('/data/fetchAllFormData')
    //     .then(response => response.json())
    //     .then(data => {
    //         console.log("Fetched data:", data);
    //         data.forEach(item => {
    //             item.imageData.forEach((imageData, index) => {
    //                 // Get the base64 string of the image
    //                 const base64String = `data:image/png;base64,${imageData}`;
    //
    //                 // Create an img element and set the src to the base64 image
    //                 const imgElement = document.createElement('img');
    //                 imgElement.src = base64String;
    //                 imgElement.alt = `Image ${index + 1}`; // Image index as alt text
    //                 imgElement.style.margin = "5px";
    //
    //                 // Optionally, display the image index as a label
    //                 const label = document.createElement('div');
    //                 label.innerText = `Image ${index + 1}`;
    //
    //                 // Append the image and label to the DOM (e.g., to a container element)
    //                 const container = document.getElementById('imageContainer');
    //                 container.appendChild(label);
    //                 container.appendChild(imgElement);
    //             });
    //         });
    //     });


</script>


<script>

    //---------------START ALERT  LOGIC For Information Centre and Command Centre----------------
    document.getElementById('masterDataUpload').onclick = function () {
        document.getElementById('masterDataUpload').style.display = 'flex';
        showTab('IC');
    };

    function closeMasterDataModal() {
        document.getElementById('masterDataUpload').style.display = 'none';
    }

    // Modal logic
    document.getElementById('notificationBell').onclick = function () {
        document.getElementById('notificationModal').style.display = 'flex';
        showTab('IC');
    };

    function closeModal() {
        document.getElementById('notificationModal').style.display = 'none';
    }

    document.getElementById('tabIC').onclick = function () {
        showTab('IC');
    };
    document.getElementById('tabCC').onclick = function () {
        showTab('CC');
    };

    function showTab(tab) {
        document.getElementById('formIC').style.display = tab === 'IC' ? 'block' : 'none';
        document.getElementById('formCC').style.display = tab === 'CC' ? 'block' : 'none';
        document.getElementById('tabIC').style.background = tab === 'IC' ? '#f5f5f5' : '#fff';
        document.getElementById('tabCC').style.background = tab === 'CC' ? '#f5f5f5' : '#fff';
    }

    // Submit Information Centre
    function submitIC() {
        const message = document.getElementById('icMessage').value.trim();
        if (!message) return alert('Please enter a message.');
        fetch('/data/sendNotification', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                type: 'IC',
                message: message
            })
        }).then(res => res.text()).then(msg => {
            alert(msg);
            closeModal();
        });
    }

    // Submit Command Centre
    function submitCC() {
        const message = document.getElementById('ccMessage').value.trim();
        const latitude = document.getElementById('latitude').value.trim();
        const longitude = document.getElementById('longitude').value.trim();
        if (!message || !latitude || !longitude) return alert('Please fill all fields.');
        fetch('/data/sendNotification', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                type: 'CC',
                message: message,
                latitude: latitude,
                longitude: longitude
            })
        }).then(res => res.text()).then(msg => {
            alert(msg);
            closeModal();
        });
    }

    //---------------END ALERT  LOGIC For Information Centre and Command Centre----------------


    //---------------START BUS LOGIC STARTED----------------

    function showBusDetails(busNo) {
        const modal = document.getElementById('busDetailsModal');
        const content = document.getElementById('busDetailsContent');
        const title = document.querySelector('.bus-details-title');

        // Filter users for this bus
        const busUsers = users.filter(user => user.busNo === busNo);

        // Update modal title
        title.textContent = `Bus ${busNo} Details`;

        // Clear previous content
        content.innerHTML = '';

        if (busUsers.length > 0) {
            // Create table
            const table = document.createElement('table');
            table.className = 'bus-details-table';
            table.innerHTML = `
                <thead>
                    <tr>
                        <th>Username</th>
                        <th>Last Active</th>
                        <th>Distance from Destination</th>
                        <th>ETA</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                    ${busUsers.map(user => `
                        <tr>
                            <td><b>${user.name}</b></td>
                            <td>${formatDateTime(user.lastActiveAt) || '-'}</td>
                            <td>${user.distance || 'Calculating...'}</td>
                            <td>${user.eta || 'Calculating...'}</td>
                            <td><span class="bus-user-status ${user.tracking ? 'status-active' : 'status-inactive'}">${user.tracking ? 'ACTIVE' : 'INACTIVE'}</span></td>
                        </tr>
                    `).join('')}
                </tbody>
            `;
            content.appendChild(table);
        } else {
            content.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">No users found for this bus.</div>';
        }

        modal.style.display = 'flex';
    }

    function closeBusDetailsModal() {
        document.getElementById('busDetailsModal').style.display = 'none';
    }

    // Close modal when clicking outside
    window.onclick = function (event) {
        const modal = document.getElementById('busDetailsModal');
        if (event.target === modal) {
            closeBusDetailsModal();
        }
    }
    //---------------END BUS LOGIC ENDED----------------

</script>

<script>
    //---------------START MASTER DATA UPLOAD MODAL LOGIC----------------
    function openUploadModal() {
        document.getElementById('uploadModal').style.display = 'flex';
        document.getElementById('masterDataFile').value = '';
        document.getElementById('uploadFeedback').textContent = '';
        document.getElementById('uploadProgress').style.display = 'none';
        document.getElementById('uploadProgressBar').style.width = '0';
    }

    function closeUploadModal() {
        document.getElementById('uploadModal').style.display = 'none';
    }

    document.getElementById('masterDataUpload').onclick = openUploadModal;

    function uploadMasterData() {
        const fileInput = document.getElementById('masterDataFile');
        const feedback = document.getElementById('uploadFeedback');
        const progress = document.getElementById('uploadProgress');
        const progressBar = document.getElementById('uploadProgressBar');
        feedback.textContent = '';
        progress.style.display = 'block';
        progressBar.style.width = '0';

        const file = fileInput.files[0];
        if (!file) {
            feedback.textContent = 'Please select a file.';
            progress.style.display = 'none';
            return;
        }
        const formData = new FormData();
        formData.append('file', file);

        const xhr = new XMLHttpRequest();
        xhr.open('POST', '/data/addMasterData', true);
        xhr.upload.onprogress = function (e) {
            if (e.lengthComputable) {
                const percent = Math.round((e.loaded / e.total) * 100);
                progressBar.style.width = percent + '%';
            }
        };
        xhr.onload = function () {
            if (xhr.status === 200) {
                feedback.textContent = 'Upload successful!';
                feedback.style.color = '#2e7d32';
            } else {
                feedback.textContent = 'Upload failed. Please try again.';
                feedback.style.color = '#c62828';
            }
            progressBar.style.width = '100%';
        };
        xhr.onerror = function () {
            feedback.textContent = 'Upload failed. Please try again.';
            feedback.style.color = '#c62828';
            progress.style.display = 'none';
        };
        xhr.send(formData);
    }

    // Close modal on outside click
    window.addEventListener('click', function (event) {
        const modal = document.getElementById('uploadModal');
        if (event.target === modal) {
            closeUploadModal();
        }
    });
    //---------------END MASTER DATA UPLOAD MODAL LOGIC----------------

</script>
</body>
</html>
